---
title: "Web Fetch Tool - Plan"
phase: Plan
date: "2025-12-09T18:45:00Z"
owner: "claude"
parent_research: "memory-bank/research/2025-12-09_18-26-42_web-fetch-tool.md"
git_commit_at_plan: "afff495"
tags: [plan, web-fetch, tools, http]
---

## Goal

Implement a `web_fetch` tool that fetches web content via HTTP GET and returns it as plain text, enabling the agent to retrieve documentation, API references, and web resources during coding tasks.

**Non-goals:**
- Web search functionality (requires external API - separate concern)
- JavaScript rendering (static HTML only)
- Caching layer (defer to future iteration)
- POST/PUT/DELETE methods (GET only for read-only tool)

## Scope & Assumptions

**In Scope:**
- HTTP GET requests with configurable timeout
- HTML-to-text conversion for readable output
- URL security validation (block localhost, private IPs, file://)
- Content size limiting (5MB max)
- Integration with existing tool infrastructure

**Out of Scope:**
- WebSearch tool (separate implementation)
- Cookie/session handling
- Authentication headers
- Rate limiting infrastructure

**Assumptions:**
- httpx v0.28.1 available (confirmed in codebase)
- html2text library acceptable as new dependency (small, focused)
- Tool classified as READ_ONLY (no filesystem modification)

## Deliverables (DoD)

1. `src/tunacode/tools/web_fetch.py` - Tool implementation with @base_tool decorator
2. `src/tunacode/tools/prompts/web_fetch_prompt.xml` - LLM-facing documentation
3. `ToolName.WEB_FETCH` added to `src/tunacode/constants.py`
4. Tool registered in `src/tunacode/core/agents/agent_components/agent_config.py`
5. `html2text` added to `pyproject.toml` dependencies

**Acceptance Criteria:**
- Tool fetches `https://example.com` and returns readable text
- Blocks `http://localhost`, `file://`, private IP ranges
- Returns ModelRetry on timeout, invalid URL, connection errors
- Returns ToolExecutionError on content > 5MB
- Integrated in agent tools_list and functional in TUI

## Readiness (DoR)

- [x] Research document completed and validated
- [x] httpx available in dependencies
- [x] Tool decorator pattern understood
- [x] XML prompt structure documented
- [x] Registration pattern confirmed
- [ ] html2text dependency to be added

## Milestones

- **M1: Foundation** - Add dependency, create tool skeleton with security validation
- **M2: Core Feature** - HTTP fetch with HTML-to-text conversion
- **M3: Integration** - Register tool, add XML prompt, update constants
- **M4: Verification** - Manual testing via TUI

## Work Breakdown (Tasks)

| ID | Task | Owner | Milestone | Dependencies |
|----|------|-------|-----------|--------------|
| T1 | Add html2text to pyproject.toml | claude | M1 | - |
| T2 | Create web_fetch.py with URL validation | claude | M1 | T1 |
| T3 | Implement HTTP GET with timeout/size limits | claude | M2 | T2 |
| T4 | Add HTML-to-text conversion | claude | M2 | T3 |
| T5 | Create web_fetch_prompt.xml | claude | M3 | T4 |
| T6 | Add WEB_FETCH to ToolName enum | claude | M3 | T4 |
| T7 | Register tool in agent_config.py | claude | M3 | T5, T6 |
| T8 | Manual TUI verification | claude | M4 | T7 |

### Task Details

**T2 - URL Validation (Files: `src/tunacode/tools/web_fetch.py`)**
- Block patterns: `file://`, `localhost`, `127.0.0.1`, `0.0.0.0`, `192.168.*`, `10.*`, `172.16-31.*`
- Validate URL scheme is http/https
- Raise ModelRetry on invalid URL

**T3 - HTTP GET Implementation (Files: `src/tunacode/tools/web_fetch.py`)**
- Use `httpx.AsyncClient(timeout=60)`
- Check Content-Length before download (5MB limit)
- Stream response to enforce size limit
- Return ModelRetry on timeout, connection errors

**T4 - HTML Conversion (Files: `src/tunacode/tools/web_fetch.py`)**
- Use html2text for HTML responses (Content-Type: text/html)
- Pass through plain text responses unchanged
- Truncate output if exceeds reasonable length (100KB)

**T6 - Constants Update (Files: `src/tunacode/constants.py`)**
- Add `WEB_FETCH = "web_fetch"` to ToolName enum
- Add to READ_ONLY_TOOLS list

**T7 - Registration (Files: `src/tunacode/core/agents/agent_components/agent_config.py`)**
- Import: `from tunacode.tools.web_fetch import web_fetch`
- Add to tools_list: `Tool(web_fetch, max_retries=max_retries, strict=tool_strict_validation)`

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation | Trigger |
|------|--------|------------|------------|---------|
| html2text has security issues | High | Low | Audit package, consider beautifulsoup4 fallback | CVE found |
| Large pages cause memory issues | Medium | Medium | Streaming download with size checks | OOM in testing |
| SSRF via redirect to internal IP | High | Low | Validate final URL after redirects | Security review |

## Test Strategy

**Single Integration Test:** `tests/test_web_fetch.py`
- Test URL validation blocks localhost/private IPs
- Test successful fetch of https://example.com (if network available, else mock)

## References

- Research: `memory-bank/research/2025-12-09_18-26-42_web-fetch-tool.md`
- Tool decorator: `src/tunacode/tools/decorators.py:22-56`
- Registration pattern: `src/tunacode/core/agents/agent_components/agent_config.py:346-360`
- ToolName enum: `src/tunacode/constants.py:46-57`
- Existing tool example: `src/tunacode/tools/bash.py`

---

## Alternative Option (Deferred)

**Minimal Implementation (No New Dependency):**
- Skip HTML-to-text conversion
- Return raw HTML with truncation
- Simpler but less useful for LLM consumption

Recommendation: Proceed with html2text dependency for better agent experience.

---

## Final Gate Summary

- **Plan Path:** `memory-bank/plan/2025-12-09_18-45-00_web-fetch-tool.md`
- **Milestones:** 4 (Foundation, Core, Integration, Verification)
- **Tasks:** 8
- **New Files:** 2 (`web_fetch.py`, `web_fetch_prompt.xml`)
- **Modified Files:** 3 (`pyproject.toml`, `constants.py`, `agent_config.py`)
- **New Dependency:** 1 (`html2text`)
- **Tests:** 1

**Next Command:**
```
/ce-ex memory-bank/plan/2025-12-09_18-45-00_web-fetch-tool.md
```
