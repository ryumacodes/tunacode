<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESC Key Logic Flow - TunaCode TUI</title>
    <style>
:root { --bg-primary: #1a1a2e; --bg-secondary: #16213e; --bg-tertiary: #0f3460; --accent: #e94560; --accent-secondary: #533483; --text-primary: #eaeaea; --text-secondary: #a0a0a0; --border: #2a2a4a; --success: #4ecca3; --warning: #ffc107; --info: #17a2b8; } * { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; padding: 2rem; } .container { max-width: 1400px; margin: 0 auto; } h1 { text-align: center; margin-bottom: 0.5rem; color: var(--accent); font-size: 2.5rem; } .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 2rem; font-size: 1.1rem; } .section { background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border); } .section h2 { color: var(--accent); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--accent); font-size: 1.4rem; } .section h3 { color: var(--success); margin: 1.5rem 0 0.75rem 0; font-size: 1.1rem; } /* Flow Diagram Styles */ .flow-container { display: flex; flex-direction: column; align-items: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 8px; overflow-x: auto; } .flow-node { background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; padding: 1rem 1.5rem; margin: 0.5rem; text-align: center; min-width: 200px; position: relative; } .flow-node.start { background: var(--accent); color: white; font-weight: bold; } .flow-node.decision { background: var(--accent-secondary); border-color: var(--accent-secondary); transform: rotate(0deg); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; } .flow-node.action { background: var(--bg-tertiary); border-color: var(--success); border-width: 2px; } .flow-node.end { background: var(--text-secondary); color: var(--bg-primary); } .flow-arrow { color: var(--text-secondary); font-size: 1.5rem; margin: 0.25rem 0; } .flow-row { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 1rem; } .flow-branch { display: flex; flex-direction: column; align-items: center; } .branch-label { background: var(--success); color: var(--bg-primary); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin: 0.25rem; } .branch-label.no { background: var(--warning); } /* Component Diagram */ .component-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem; } .component-card { background: var(--bg-tertiary); border-radius: 8px; padding: 1.25rem; border-left: 4px solid var(--accent); } .component-card h4 { color: var(--accent); margin-bottom: 0.5rem; font-size: 1rem; } .component-card .file-path { font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; color: var(--success); background: var(--bg-primary); padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; margin-bottom: 0.75rem; } .component-card .line-ref { color: var(--warning); } .component-card p { color: var(--text-secondary); font-size: 0.9rem; } .component-card ul { margin-top: 0.5rem; padding-left: 1.25rem; } .component-card li { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem; } /* Relationship Diagram */ .relationship-container { background: var(--bg-tertiary); border-radius: 8px; padding: 2rem; margin-top: 1rem; } .relationship-svg { width: 100%; max-width: 1000px; margin: 0 auto; display: block; } /* Code Block */ .code-block { background: #0d1117; border-radius: 6px; padding: 1rem; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; overflow-x: auto; margin: 1rem 0; border: 1px solid var(--border); } .code-block .keyword { color: #ff7b72; } .code-block .function { color: #d2a8ff; } .code-block .string { color: #a5d6ff; } .code-block .comment { color: #8b949e; } .code-block .property { color: #79c0ff; } /* Table Styles */ table { width: 100%; border-collapse: collapse; margin: 1rem 0; } th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); } th { background: var(--bg-tertiary); color: var(--accent); font-weight: 600; } tr:hover { background: var(--bg-tertiary); } td code { background: var(--bg-primary); padding: 0.15rem 0.4rem; border-radius: 3px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; color: var(--success); } /* Priority Badge */ .priority-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: bold; margin-left: 0.5rem; } .priority-1 { background: var(--accent); color: white; } .priority-2 { background: var(--warning); color: black; } .priority-3 { background: var(--info); color: white; } /* Legend */ .legend { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; } .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; } .legend-color { width: 20px; height: 20px; border-radius: 4px; } /* Sequence Diagram */ .sequence-container { background: var(--bg-tertiary); border-radius: 8px; padding: 1.5rem; overflow-x: auto; } .sequence-row { display: flex; align-items: stretch; min-height: 60px; position: relative; } .sequence-actor { width: 120px; text-align: center; font-weight: bold; color: var(--accent); flex-shrink: 0; } .sequence-actor.header { background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; } .sequence-lifeline { position: absolute; left: 60px; top: 0; bottom: 0; width: 2px; background: var(--border); } .sequence-message { flex: 1; display: flex; align-items: center; padding: 0.5rem 1rem; position: relative; } .sequence-arrow { height: 2px; background: var(--success); flex: 1; position: relative; margin: 0 1rem; } .sequence-arrow::after { content: ''; position: absolute; right: 0; top: -4px; border: 5px solid transparent; border-left-color: var(--success); } .sequence-arrow.return { background: var(--text-secondary); } .sequence-arrow.return::after { border-left-color: transparent; border-right-color: var(--text-secondary); right: auto; left: 0; } .sequence-label { font-size: 0.85rem; white-space: nowrap; } /* Modal Section */ .modal-flow { display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-top: 1rem; } .modal-step { display: flex; align-items: center; gap: 1rem; } .modal-step-num { width: 30px; height: 30px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; } .modal-step-content { flex: 1; } .modal-step-arrow { color: var(--text-secondary); margin-left: 15px; }
</style>
</head>
<body>
    <div class="container">
        <h1>ESC Key Logic Flow</h1>
        <p class="subtitle">TunaCode TUI - Component Relationships and Event Flow</p>

        <!-- Overview Section -->
        <div class="section">
            <h2>Architecture Overview</h2>
            <p>The ESC key handling in TunaCode follows a <strong>priority cascade pattern</strong> with layered interception. Events flow through the Textual framework's event system, with modal screens having the highest priority, followed by the application-level handler.</p>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent);"></div>
                    <span>Entry Point / Trigger</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-secondary);"></div>
                    <span>Decision Node</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--success);"></div>
                    <span>Action / Handler</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--text-secondary);"></div>
                    <span>Terminal State</span>
                </div>
            </div>
        </div>

        <!-- Main Flow Diagram -->
        <div class="section">
            <h2>Primary ESC Event Flow</h2>
            <div class="flow-container">
                <svg viewBox="0 0 900 700" class="relationship-svg">
                    <!-- Background -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4ecca3"/>
                        </marker>
                        <marker id="arrowhead-gray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#a0a0a0"/>
                        </marker>
                        <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#e94560"/>
                        </marker>
                    </defs>

                    <!-- Start Node -->
                    <rect x="350" y="20" width="200" height="50" rx="8" fill="#e94560"/>
                    <text x="450" y="50" text-anchor="middle" fill="white" font-weight="bold" font-size="14">User Presses ESC</text>

                    <!-- Arrow to first decision -->
                    <line x1="450" y1="70" x2="450" y2="100" stroke="#4ecca3" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Modal Check Decision -->
                    <polygon points="450,110 550,160 450,210 350,160" fill="#533483" stroke="#533483" stroke-width="2"/>
                    <text x="450" y="155" text-anchor="middle" fill="white" font-size="12">Modal Screen</text>
                    <text x="450" y="170" text-anchor="middle" fill="white" font-size="12">Active?</text>

                    <!-- YES branch to Modal Handler -->
                    <line x1="550" y1="160" x2="700" y2="160" stroke="#4ecca3" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <rect x="580" y="140" width="40" height="20" rx="4" fill="#4ecca3"/>
                    <text x="600" y="154" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">YES</text>

                    <!-- Modal Handler Box -->
                    <rect x="710" y="120" width="160" height="80" rx="8" fill="#0f3460" stroke="#4ecca3" stroke-width="2"/>
                    <text x="790" y="145" text-anchor="middle" fill="#4ecca3" font-size="12" font-weight="bold">Modal Handler</text>
                    <text x="790" y="165" text-anchor="middle" fill="#a0a0a0" font-size="10">on_key() or</text>
                    <text x="790" y="180" text-anchor="middle" fill="#a0a0a0" font-size="10">action_cancel()</text>

                    <!-- Modal to Dismiss -->
                    <line x1="790" y1="200" x2="790" y2="240" stroke="#4ecca3" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Dismiss Box -->
                    <rect x="710" y="250" width="160" height="50" rx="8" fill="#a0a0a0"/>
                    <text x="790" y="280" text-anchor="middle" fill="#1a1a2e" font-size="12" font-weight="bold">screen.dismiss()</text>

                    <!-- NO branch down -->
                    <line x1="450" y1="210" x2="450" y2="260" stroke="#a0a0a0" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
                    <rect x="430" y="220" width="40" height="20" rx="4" fill="#ffc107"/>
                    <text x="450" y="234" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">NO</text>

                    <!-- App Handler Box -->
                    <rect x="350" y="270" width="200" height="50" rx="8" fill="#0f3460" stroke="#17a2b8" stroke-width="2"/>
                    <text x="450" y="295" text-anchor="middle" fill="#17a2b8" font-size="12" font-weight="bold">action_cancel_request()</text>
                    <text x="450" y="310" text-anchor="middle" fill="#a0a0a0" font-size="10">app.py:343-356</text>

                    <!-- Arrow to Request Check -->
                    <line x1="450" y1="320" x2="450" y2="360" stroke="#4ecca3" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Request Task Decision -->
                    <polygon points="450,370 530,410 450,450 370,410" fill="#533483" stroke="#533483" stroke-width="2"/>
                    <text x="450" y="405" text-anchor="middle" fill="white" font-size="11">Request</text>
                    <text x="450" y="420" text-anchor="middle" fill="white" font-size="11">Running?</text>

                    <!-- YES to Cancel Task -->
                    <line x1="530" y1="410" x2="650" y2="410" stroke="#4ecca3" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <rect x="545" y="390" width="40" height="20" rx="4" fill="#4ecca3"/>
                    <text x="565" y="404" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">YES</text>

                    <rect x="660" y="385" width="130" height="50" rx="8" fill="#0f3460" stroke="#4ecca3" stroke-width="2"/>
                    <text x="725" y="408" text-anchor="middle" fill="#4ecca3" font-size="11">task.cancel()</text>
                    <text x="725" y="423" text-anchor="middle" fill="#a0a0a0" font-size="9">RETURN</text>

                    <!-- NO to Shell Check -->
                    <line x1="450" y1="450" x2="450" y2="490" stroke="#a0a0a0" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
                    <rect x="430" y="455" width="40" height="20" rx="4" fill="#ffc107"/>
                    <text x="450" y="469" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">NO</text>

                    <!-- Shell Decision -->
                    <polygon points="450,500 530,540 450,580 370,540" fill="#533483" stroke="#533483" stroke-width="2"/>
                    <text x="450" y="535" text-anchor="middle" fill="white" font-size="11">Shell</text>
                    <text x="450" y="550" text-anchor="middle" fill="white" font-size="11">Running?</text>

                    <!-- YES to Cancel Shell -->
                    <line x1="530" y1="540" x2="650" y2="540" stroke="#4ecca3" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <rect x="545" y="520" width="40" height="20" rx="4" fill="#4ecca3"/>
                    <text x="565" y="534" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">YES</text>

                    <rect x="660" y="515" width="130" height="50" rx="8" fill="#0f3460" stroke="#4ecca3" stroke-width="2"/>
                    <text x="725" y="538" text-anchor="middle" fill="#4ecca3" font-size="11">shell.cancel()</text>
                    <text x="725" y="553" text-anchor="middle" fill="#a0a0a0" font-size="9">RETURN</text>

                    <!-- NO to Editor Check -->
                    <line x1="450" y1="580" x2="450" y2="620" stroke="#a0a0a0" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
                    <rect x="430" y="585" width="40" height="20" rx="4" fill="#ffc107"/>
                    <text x="450" y="599" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">NO</text>

                    <!-- Editor Decision -->
                    <polygon points="450,630 530,670 450,710 370,670" fill="#533483" stroke="#533483" stroke-width="2"/>
                    <text x="450" y="665" text-anchor="middle" fill="white" font-size="11">Editor Has</text>
                    <text x="450" y="680" text-anchor="middle" fill="white" font-size="11">Content?</text>

                    <!-- YES to Clear Editor -->
                    <line x1="530" y1="670" x2="650" y2="670" stroke="#4ecca3" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <rect x="545" y="650" width="40" height="20" rx="4" fill="#4ecca3"/>
                    <text x="565" y="664" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">YES</text>

                    <rect x="660" y="645" width="130" height="50" rx="8" fill="#0f3460" stroke="#4ecca3" stroke-width="2"/>
                    <text x="725" y="668" text-anchor="middle" fill="#4ecca3" font-size="11">editor.clear_input()</text>
                    <text x="725" y="683" text-anchor="middle" fill="#a0a0a0" font-size="9">editor.py:110</text>

                    <!-- NO to No Action -->
                    <line x1="370" y1="670" x2="250" y2="670" stroke="#a0a0a0" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
                    <rect x="290" y="650" width="40" height="20" rx="4" fill="#ffc107"/>
                    <text x="310" y="664" text-anchor="middle" fill="#1a1a2e" font-size="11" font-weight="bold">NO</text>

                    <rect x="100" y="645" width="140" height="50" rx="8" fill="#a0a0a0"/>
                    <text x="170" y="675" text-anchor="middle" fill="#1a1a2e" font-size="12" font-weight="bold">No Action</text>

                    <!-- Priority Labels -->
                    <rect x="30" y="370" width="100" height="25" rx="4" fill="#e94560"/>
                    <text x="80" y="387" text-anchor="middle" fill="white" font-size="10" font-weight="bold">PRIORITY 1</text>

                    <rect x="30" y="500" width="100" height="25" rx="4" fill="#ffc107"/>
                    <text x="80" y="517" text-anchor="middle" fill="#1a1a2e" font-size="10" font-weight="bold">PRIORITY 2</text>

                    <rect x="30" y="630" width="100" height="25" rx="4" fill="#17a2b8"/>
                    <text x="80" y="647" text-anchor="middle" fill="white" font-size="10" font-weight="bold">PRIORITY 3</text>
                </svg>
            </div>
        </div>

        <!-- Component Relationships -->
        <div class="section">
            <h2>Component Relationships</h2>
            <div class="component-grid">
                <div class="component-card">
                    <h4>TunaApp (Main Application)</h4>
                    <div class="file-path">src/tunacode/ui/app.py</div>
                    <p>Central coordinator for all ESC handling. Defines global binding and priority cascade.</p>
                    <ul>
                        <li><span class="line-ref">Line 65:</span> ESC binding with <code>priority=True</code></li>
                        <li><span class="line-ref">Lines 343-356:</span> <code>action_cancel_request()</code></li>
                        <li>Owns references to: Editor, ShellRunner, request task</li>
                    </ul>
                </div>

                <div class="component-card">
                    <h4>Editor Widget</h4>
                    <div class="file-path">src/tunacode/ui/widgets/editor.py</div>
                    <p>Input widget for user text. Provides <code>clear_input()</code> method called by app.</p>
                    <ul>
                        <li><span class="line-ref">Lines 110-113:</span> <code>clear_input()</code></li>
                        <li><span class="line-ref">Line 54-55:</span> <code>has_paste_buffer</code> property</li>
                        <li>No direct ESC handling - delegated to app</li>
                    </ul>
                </div>

                <div class="component-card">
                    <h4>ShellRunner</h4>
                    <div class="file-path">src/tunacode/ui/shell_runner.py</div>
                    <p>Manages shell command execution. Provides cancellation interface.</p>
                    <ul>
                        <li><span class="line-ref">Lines 119-137:</span> <code>cancel()</code> method</li>
                        <li><span class="line-ref">Line 111:</span> "Esc to cancel" notification</li>
                        <li>Terminates subprocess on cancel</li>
                    </ul>
                </div>

                <div class="component-card">
                    <h4>Modal Screens</h4>
                    <div class="file-path">src/tunacode/ui/screens/*.py</div>
                    <p>Pushed onto screen stack. Each handles its own ESC to dismiss.</p>
                    <ul>
                        <li>ModelPickerScreen - two-phase ESC</li>
                        <li>ProviderPickerScreen - two-phase ESC</li>
                        <li>SessionPickerScreen - direct dismiss</li>
                        <li>ThemePickerScreen - revert + dismiss</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modal Two-Phase Flow -->
        <div class="section">
            <h2>Modal Two-Phase ESC Pattern</h2>
            <p>Model and Provider picker screens implement a two-phase ESC behavior for better UX:</p>

            <div class="modal-flow">
                <div class="modal-step">
                    <div class="modal-step-num">1</div>
                    <div class="modal-step-content">
                        <strong>User types filter text</strong> (e.g., "gpt" to filter models)
                        <br><code style="color: var(--success);">self._filter_query = "gpt"</code>
                    </div>
                </div>
                <div class="modal-step-arrow">|</div>
                <div class="modal-step">
                    <div class="modal-step-num">2</div>
                    <div class="modal-step-content">
                        <strong>First ESC press</strong> - clears filter, keeps modal open
                        <br><code style="color: var(--warning);">on_key(): if escape and _filter_query: clear filter, event.stop()</code>
                    </div>
                </div>
                <div class="modal-step-arrow">|</div>
                <div class="modal-step">
                    <div class="modal-step-num">3</div>
                    <div class="modal-step-content">
                        <strong>Second ESC press</strong> - filter empty, dismisses modal
                        <br><code style="color: var(--accent);">action_cancel(): self.dismiss(None)</code>
                    </div>
                </div>
            </div>

            <h3>Implementation Location</h3>
            <div class="code-block">
<span class="comment"># src/tunacode/ui/screens/model_picker.py:160-164</span>
<span class="keyword">elif</span> event.key == <span class="string">"escape"</span> <span class="keyword">and</span> <span class="property">self</span>._filter_query:
    filter_input.value = <span class="string">""</span>
    <span class="property">self</span>._filter_query = <span class="string">""</span>
    <span class="property">self</span>._rebuild_options()
    event.<span class="function">stop</span>()  <span class="comment"># Prevents propagation to action_cancel binding</span>
            </div>
        </div>

        <!-- File Reference Table -->
        <div class="section">
            <h2>Complete File Reference</h2>
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Lines</th>
                        <th>Component</th>
                        <th>ESC Behavior</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>ui/app.py</code></td>
                        <td>65</td>
                        <td>Binding</td>
                        <td>Global ESC binding with <code>priority=True</code></td>
                    </tr>
                    <tr>
                        <td><code>ui/app.py</code></td>
                        <td>343-356</td>
                        <td>Handler</td>
                        <td>Priority cascade: request > shell > editor</td>
                    </tr>
                    <tr>
                        <td><code>ui/widgets/editor.py</code></td>
                        <td>110-113</td>
                        <td>Method</td>
                        <td><code>clear_input()</code> - clears value and paste buffer</td>
                    </tr>
                    <tr>
                        <td><code>ui/shell_runner.py</code></td>
                        <td>119-137</td>
                        <td>Method</td>
                        <td><code>cancel()</code> - terminates shell subprocess</td>
                    </tr>
                    <tr>
                        <td><code>ui/screens/model_picker.py</code></td>
                        <td>94, 160-164</td>
                        <td>ProviderPicker</td>
                        <td>Two-phase: clear filter, then dismiss</td>
                    </tr>
                    <tr>
                        <td><code>ui/screens/model_picker.py</code></td>
                        <td>212, 289-293</td>
                        <td>ModelPicker</td>
                        <td>Two-phase: clear filter, then dismiss</td>
                    </tr>
                    <tr>
                        <td><code>ui/screens/session_picker.py</code></td>
                        <td>55, 179-181</td>
                        <td>SessionPicker</td>
                        <td>Direct dismiss with <code>None</code></td>
                    </tr>
                    <tr>
                        <td><code>ui/screens/theme_picker.py</code></td>
                        <td>48, 87-90</td>
                        <td>ThemePicker</td>
                        <td>Revert theme, dismiss with <code>None</code></td>
                    </tr>
                    <tr>
                        <td><code>ui/screens/update_confirm.py</code></td>
                        <td>46, 68-69</td>
                        <td>UpdateConfirm</td>
                        <td>Dismiss with <code>False</code></td>
                    </tr>
                    <tr>
                        <td><code>ui/screens/setup.py</code></td>
                        <td>29, 100-102</td>
                        <td>SetupScreen</td>
                        <td>Skip setup, dismiss with <code>False</code></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Event Propagation -->
        <div class="section">
            <h2>Textual Event Propagation</h2>
            <div class="relationship-container">
                <svg viewBox="0 0 800 300" class="relationship-svg">
                    <!-- Layers -->
                    <rect x="50" y="30" width="700" height="60" rx="8" fill="#533483" opacity="0.3"/>
                    <text x="70" y="65" fill="white" font-size="14" font-weight="bold">Screen Stack (Modals)</text>

                    <rect x="50" y="110" width="700" height="60" rx="8" fill="#0f3460" opacity="0.5"/>
                    <text x="70" y="145" fill="white" font-size="14" font-weight="bold">Application Layer</text>

                    <rect x="50" y="190" width="700" height="60" rx="8" fill="#16213e"/>
                    <text x="70" y="225" fill="white" font-size="14" font-weight="bold">Widget Layer (Editor, etc.)</text>

                    <!-- Event flow arrows -->
                    <path d="M 400 270 L 400 250 L 400 170 L 400 90 L 400 70" stroke="#e94560" stroke-width="3" fill="none" marker-end="url(#arrowhead-red)"/>

                    <!-- Labels -->
                    <text x="420" y="260" fill="#e94560" font-size="12">ESC Event</text>
                    <text x="420" y="240" fill="#a0a0a0" font-size="10">Bubbles up</text>

                    <!-- Interception points -->
                    <circle cx="400" cy="60" r="8" fill="#4ecca3"/>
                    <text x="420" y="65" fill="#4ecca3" font-size="11">Modal intercepts first (if present)</text>

                    <circle cx="400" cy="140" r="8" fill="#4ecca3"/>
                    <text x="420" y="145" fill="#4ecca3" font-size="11">App binding (priority=True)</text>

                    <circle cx="400" cy="220" r="8" fill="#a0a0a0"/>
                    <text x="420" y="225" fill="#a0a0a0" font-size="11">No ESC handling in Editor widget</text>

                    <!-- Priority note -->
                    <rect x="550" y="100" width="180" height="80" rx="6" fill="#0f3460" stroke="#ffc107" stroke-width="2"/>
                    <text x="640" y="125" text-anchor="middle" fill="#ffc107" font-size="11" font-weight="bold">priority=True</text>
                    <text x="640" y="145" text-anchor="middle" fill="#a0a0a0" font-size="10">Ensures app ESC runs</text>
                    <text x="640" y="160" text-anchor="middle" fill="#a0a0a0" font-size="10">before lower-priority</text>
                    <text x="640" y="175" text-anchor="middle" fill="#a0a0a0" font-size="10">widget bindings</text>
                </svg>
            </div>
        </div>

        <!-- Key Takeaways -->
        <div class="section">
            <h2>Key Takeaways</h2>
            <div class="component-grid">
                <div class="component-card" style="border-left-color: var(--success);">
                    <h4>Priority Cascade Pattern</h4>
                    <p>The <code>action_cancel_request()</code> method uses early returns to implement a clear priority order. First matching condition wins.</p>
                </div>
                <div class="component-card" style="border-left-color: var(--warning);">
                    <h4>Modal Screen Isolation</h4>
                    <p>Modal screens handle their own ESC independently. They intercept the event before it reaches the app layer via <code>event.stop()</code>.</p>
                </div>
                <div class="component-card" style="border-left-color: var(--info);">
                    <h4>No Hidden Chat State</h4>
                    <p>The ChatContainer is always visible. ESC never hides the chat - it only cancels operations or clears input.</p>
                </div>
                <div class="component-card" style="border-left-color: var(--accent-secondary);">
                    <h4>Two-Phase UX</h4>
                    <p>Pickers with filters require two ESC presses: first clears filter, second dismisses. This prevents accidental closure.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; color: var(--text-secondary); margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <p>Generated: 2026-02-02 | TunaCode TUI ESC Key Flow Documentation</p>
        </div>
    </div>
</body>
</html>
