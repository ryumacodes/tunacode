<!DOCTYPE html>
<html>
<head>
    <title>Issue #314: Layer 2 Lateral Coupling Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 40px;
        }
        h1 {
            color: #fff;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        .issue-link {
            color: #4a9eff;
            text-decoration: none;
        }
        .issue-link:hover {
            text-decoration: underline;
        }
        .container {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }
        .chart {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
            flex: 1;
            min-width: 450px;
        }
        h2 {
            margin-top: 0;
            color: #ff6b6b;
        }
        .after h2 {
            color: #69db7c;
        }
        .violation {
            color: #ff6b6b;
            font-weight: bold;
        }
        .fixed {
            color: #69db7c;
            font-weight: bold;
        }
        .migration {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
            margin-top: 40px;
        }
        .migration h2 {
            color: #ffd43b;
        }
        .phase {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #333;
        }
        .phase-header {
            font-weight: bold;
            color: #4a9eff;
            margin-bottom: 8px;
        }
        .move {
            padding: 4px 0;
            font-family: monospace;
            font-size: 13px;
        }
        .arrow {
            color: #69db7c;
        }
        .delete {
            color: #ff6b6b;
            text-decoration: line-through;
        }
        code {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .summary {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .summary-box {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .summary-box.bad {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
        }
        .summary-box.good {
            background: rgba(105, 219, 124, 0.2);
            border: 1px solid #69db7c;
        }
        .summary-number {
            font-size: 36px;
            font-weight: bold;
        }
        .summary-label {
            font-size: 14px;
            opacity: 0.8;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            color: #ffd43b;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .prereq {
            background: rgba(105, 219, 124, 0.1);
            border: 1px solid #69db7c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .prereq h3 {
            color: #69db7c;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Issue <a class="issue-link" href="https://github.com/alchemiststudiosDOTai/tunacode/issues/314">#314</a>: Layer 2 Lateral Coupling</h1>
    <p>Layer 2 modules (<code>tools</code>, <code>indexing</code>, <code>lsp</code>, <code>infrastructure</code>) should NOT import from each other. They are peers.</p>

    <div class="prereq">
        <h3>✓ Prerequisite Complete: Issue #313</h3>
        <p>PR #317 eliminated all <code>core → utils</code> violations. The architecture is now clean enough to address lateral coupling.</p>
    </div>

    <div class="summary">
        <div class="summary-box bad">
            <div class="summary-number violation">3</div>
            <div class="summary-label">lateral imports</div>
        </div>
        <div class="summary-box bad">
            <div class="summary-number violation">2</div>
            <div class="summary-label">files affected</div>
        </div>
        <div class="summary-box good">
            <div class="summary-number fixed">0</div>
            <div class="summary-label">target violations</div>
        </div>
    </div>

    <div class="container" style="margin-top: 40px;">
        <div class="chart before">
            <h2>BEFORE (Current State)</h2>
            <div class="mermaid">
graph TD
    ui[ui]-->|51|core[core]
    core-->|18|tools[tools]
    core-->|2|indexing[indexing]
    core-->|1|infrastructure[infrastructure]

    tools-.->|1 ❌|indexing
    tools-.->|2 ❌|lsp[lsp]

    tools-->|1|utils[utils]
    indexing-->|1|configuration
    lsp-->|1|utils

    subgraph layer2 [Layer 2 - should be independent]
        tools
        indexing
        lsp
        infrastructure
    end

    subgraph foundation [Foundation]
        types[types]
        configuration[configuration]
    end

    linkStyle 4 stroke:#ff6b6b,stroke-width:3px,stroke-dasharray:5
    linkStyle 5 stroke:#ff6b6b,stroke-width:3px,stroke-dasharray:5

    style ui fill:#f66,stroke:#333
    style core fill:#4a9eff,stroke:#333
    style tools fill:#4ade80,stroke:#333
    style indexing fill:#fb923c,stroke:#333
    style lsp fill:#c084fc,stroke:#333
    style infrastructure fill:#38bdf8,stroke:#333
    style utils fill:#facc15,stroke:#333
    style types fill:#a855f7,stroke:#333
    style configuration fill:#94a3b8,stroke:#333
    style layer2 fill:none,stroke:#ff6b6b,stroke-width:2px,stroke-dasharray:5
    style foundation fill:none,stroke:#a855f7,stroke-width:2px,stroke-dasharray:5
            </div>
            <p class="violation">Problem: tools imports from indexing and lsp (lateral coupling)</p>
        </div>

        <div class="chart after">
            <h2>AFTER (Target State)</h2>
            <div class="mermaid">
graph TD
    ui[ui]-->|51|core[core]
    core-->|18|tools[tools]
    core-->|2|indexing[indexing]
    core-->|1|infrastructure[infrastructure]
    core-.->|orchestrates|lsp[lsp]

    tools-->|1|utils[utils]
    indexing-->|1|configuration
    lsp-->|1|utils

    subgraph layer2 [Layer 2 - fully independent]
        tools
        indexing
        lsp
        infrastructure
    end

    subgraph foundation [Foundation]
        types[types]
        configuration[configuration]
    end

    style ui fill:#f66,stroke:#333
    style core fill:#4a9eff,stroke:#333
    style tools fill:#4ade80,stroke:#333
    style indexing fill:#fb923c,stroke:#333
    style lsp fill:#c084fc,stroke:#333
    style infrastructure fill:#38bdf8,stroke:#333
    style utils fill:#facc15,stroke:#333
    style types fill:#a855f7,stroke:#333
    style configuration fill:#94a3b8,stroke:#333
    style layer2 fill:none,stroke:#69db7c,stroke-width:2px,stroke-dasharray:5
    style foundation fill:none,stroke:#a855f7,stroke-width:2px,stroke-dasharray:5
            </div>
            <p class="fixed">Fixed: Layer 2 modules only depend downward, core orchestrates cross-module calls</p>
        </div>
    </div>

    <div class="migration">
        <h2>Current Violations</h2>
        <table>
            <tr>
                <th>File</th>
                <th>Line</th>
                <th>Import</th>
                <th>Used For</th>
            </tr>
            <tr>
                <td><code>tools/glob.py</code></td>
                <td>12</td>
                <td><code>from tunacode.indexing import CodeIndex</code></td>
                <td>Checking if file is indexed</td>
            </tr>
            <tr>
                <td><code>tools/lsp_status.py</code></td>
                <td>5</td>
                <td><code>from tunacode.lsp.servers import get_server_command</code></td>
                <td>Getting LSP server info</td>
            </tr>
            <tr>
                <td><code>tools/decorators.py</code></td>
                <td>73</td>
                <td><code>from tunacode.lsp import format_diagnostics, get_diagnostics</code></td>
                <td>LSP diagnostics in tool output</td>
            </tr>
        </table>
    </div>

    <div class="migration">
        <h2>Fix Strategy</h2>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #4a9eff;"></div>
                <span>Push to Core (orchestration)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #a855f7;"></div>
                <span>Extract to types/ (protocol)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #facc15;"></div>
                <span>Move to utils/ (shared)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #c084fc;"></div>
                <span>Move tool to lsp/</span>
            </div>
        </div>

        <div class="phase">
            <div class="phase-header">Fix 1: tools/glob.py → indexing (CodeIndex)</div>
            <div class="move"><strong>Option A:</strong> Inject <code>is_indexed: Callable[[Path], bool]</code> from core</div>
            <div class="move"><strong>Option B:</strong> Create <code>types/indexing.py</code> with <code>IndexProtocol</code></div>
            <div class="move"><strong>Option C:</strong> Remove indexing check from glob (simplest)</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">Recommendation: Option C - glob shouldn't need to know about indexing state</div>
        </div>

        <div class="phase">
            <div class="phase-header">Fix 2: tools/lsp_status.py → lsp (get_server_command)</div>
            <div class="move"><strong>Option A:</strong> Move <code>lsp_status.py</code> to <code>lsp/tools/status.py</code></div>
            <div class="move"><strong>Option B:</strong> Extract server info to <code>configuration/lsp_servers.py</code></div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">Recommendation: Option A - this tool IS about LSP, belongs in lsp/</div>
        </div>

        <div class="phase">
            <div class="phase-header">Fix 3: tools/decorators.py → lsp (diagnostics)</div>
            <div class="move"><strong>Option A:</strong> Inject diagnostics callback from core: <code>get_diagnostics: Callable | None</code></div>
            <div class="move"><strong>Option B:</strong> Move diagnostic formatting to <code>utils/diagnostics.py</code></div>
            <div class="move"><strong>Option C:</strong> Make LSP diagnostics optional, only call if available</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">Recommendation: Option A - core already orchestrates tool execution, can inject LSP</div>
        </div>
    </div>

    <div class="migration">
        <h2>Import Changes Summary</h2>
        <table>
            <tr>
                <th>File</th>
                <th>Before</th>
                <th>After</th>
            </tr>
            <tr>
                <td><code>tools/glob.py</code></td>
                <td><code>from tunacode.indexing import CodeIndex</code></td>
                <td>(removed - glob doesn't check index)</td>
            </tr>
            <tr>
                <td><code>tools/lsp_status.py</code></td>
                <td><code>from tunacode.lsp.servers import ...</code></td>
                <td>(moved to <code>lsp/tools/status.py</code>)</td>
            </tr>
            <tr>
                <td><code>tools/decorators.py</code></td>
                <td><code>from tunacode.lsp import get_diagnostics</code></td>
                <td><code>diagnostics_fn: Callable | None</code> (injected)</td>
            </tr>
        </table>
    </div>

    <div class="migration">
        <h2>Validation</h2>
        <p>After migration, run:</p>
        <pre style="background: #333; padding: 15px; border-radius: 8px;">
# Verify no lateral imports in Layer 2
grep -rn "from tunacode.indexing" src/tunacode/tools/
grep -rn "from tunacode.lsp" src/tunacode/tools/
grep -rn "from tunacode.tools" src/tunacode/indexing/
grep -rn "from tunacode.tools" src/tunacode/lsp/

# All should return empty

# Run tests
uv run pytest

# Verify with grimp
uv run python -c "
import grimp
g = grimp.build_graph('tunacode')
# Should find no chains between Layer 2 modules
"</pre>
    </div>

    <div class="migration">
        <h2>Why This Matters</h2>
        <table>
            <tr>
                <th>Problem</th>
                <th>With Lateral Coupling</th>
                <th>After Fix</th>
            </tr>
            <tr>
                <td>Testing</td>
                <td class="violation">Can't test tools without lsp</td>
                <td class="fixed">Each module testable in isolation</td>
            </tr>
            <tr>
                <td>Changes</td>
                <td class="violation">Changing lsp might break tools</td>
                <td class="fixed">Modules change independently</td>
            </tr>
            <tr>
                <td>Circular risk</td>
                <td class="violation">Could become bidirectional</td>
                <td class="fixed">Impossible - all go downward</td>
            </tr>
            <tr>
                <td>Deployment</td>
                <td class="violation">Must deploy together</td>
                <td class="fixed">Can split modules later</td>
            </tr>
        </table>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            flowchart: {
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
